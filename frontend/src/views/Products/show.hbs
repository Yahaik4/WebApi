<!-- Modal -->
<div id="modalDelete" class="modal " tabindex="-1">
        <div class="d-flex justify-content-center align-items-center">
            <div class="rightSession border rounded p-3 shadow mt-5 tm-bg-primary-dark position-relative" style="width: 450px;">
                <form id="editForm" method="post" action="/category/edit/{{product._id}}?_method=PUT"  class="p-2 d-flex flex-column justify-content-around gap-2 " novalidate>
                    <button type="button" class="btn-close position-absolute top-0 end-0 p-3 text-white" aria-label="Close" data-bs-dismiss="modal" data-dismiss="modal"></button>
                    <div class="modal-header">
                        <h5 class="modal-title text-white" id="modalDeleteLabel">CONFIRM</h5>             
                    </div>

                    <div class="modal-body text-white">
                        Bạn có chắc chắn muốn xóa
                    </div>
                    <div class="modal-footer">
                        <button id="btnDelete" type="button" class="btn btn-danger">Xóa bỏ</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                    <div class="alert alert-danger" style="display: none;">
                        Vui lòng nhập đầy đủ thông tin
                    </div>

                    {{#if err}}
                        <div class="alert alert-danger">
                            {{err}}
                        </div>
                    {{/if}}
                </form>
            </div>
        </div>
</div>

<div id="modalDeleteAll" class="modal " tabindex="-1">
        <div class="d-flex justify-content-center align-items-center">
            <div class="rightSession border rounded p-3 shadow mt-5 tm-bg-primary-dark position-relative" style="width: 450px;">
                <form id="formDeleteAll" action="/product/deleteAllSelected" method="post">
                    <button type="button" class="btn-close position-absolute top-0 end-0 p-3 text-white" aria-label="Close" data-bs-dismiss="modal" data-dismiss="modal"></button>
                    <div class="modal-header">
                        <h5 class="modal-title text-white" id="modalDeleteLabel">CONFIRM</h5>             
                    </div>

                    <div class="modal-body text-white">
                        Bạn có chắc chắn muốn xóa
                    </div>
                    <input type="text" name="id" class="ListId d-none">

                    <div class="modal-footer">
                        <button id="btnDeleteAll" type="submit" class="btn btn-danger">Xóa bỏ</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                    <div class="alert alert-danger" style="display: none;">
                        Vui lòng nhập đầy đủ thông tin
                    </div>

                    {{#if err}}
                        <div class="alert alert-danger">
                            {{err}}
                        </div>
                    {{/if}}
                </form>
            </div>
        </div>
</div>

<div id="toast" class="alert alert-success text-center d-none" role="alert" style="position: fixed; top: 20px; right: 20px;">
    
</div>


<form action="/product" method="get">
    <div class="row tm-content-row mt-5">
        <div class="col-12 tm-block-col">
            <div class="tm-bg-primary-dark tm-block tm-block-h-auto">
                <h2 class="tm-block-title">List of Category</h2>
                <p class="text-white">Products</p>
                <select name="category" class="custom-select m-0" onchange="this.form.submit()">
                <option value="" hidden>Select Category</option>
                    {{#each categories}}
                        <option value="{{this.name}}"
                            {{#if (eq ../selectedCategory this.name)}}selected{{/if}}>
                            {{this.name}}
                        </option>
                    {{/each}}
                        <option value="All">All</option>
                </select>
            </div>
        </div>
    </div>
</form>


<div class="row tm-content-row mt-2">
    <div class="col-sm-12 col-md-12 col-lg-8 col-xl-12 tm-block-col">
        <div class="tm-bg-primary-dark tm-block tm-block-products">
        <div class="tm-product-table-container">
            <table class="table table-hover tm-table-small tm-product-table">
                <thead>
                    <tr>
                    <th scope="col">&nbsp;</th>
                    <th scope="col">PRODUCT NAME</th>
                    <th scope="col">PRICE</th>
                    <th scope="col">IN STOCK</th>
                    <th scope="col">SIZE</th>
                    <th scope="col">COLOUR</th>
                    <th scope="col">GENDER</th>
                    <th scope="col">CATEGORY</th>
                    <th scope="col" colspan="2" class="text-center">BEHAVIOR</th>
                    </tr>
                </thead>
                <tbody>
                        {{#each products}}
                        <tr>
                            <th scope="row">
                                <input class="checkboxItem" name="productIds[]" value="{{this._id}}" type="checkbox" /></th>
                            <td class="tm-product-name">{{this.name}}</td>
                            <td>{{this.price}}</td>
                            
                            <td>{{this.stock}}</td>
                            <td>{{this.size}}</td>
                            <td>{{this.colour}}</td>
                            <td>{{this.gender}}</td>
                            <td>{{this.category}}</td>
                            <td>
                                <a href="/product/edit/{{this._id}}" class="tm-product-delete-link" data-id="{{this._id}}">
                                    <i class="far fa-edit tm-product-delete-icon"></i>
                                </a>
                            </td>
                            <td>
                                <a href="/product/{{this._id}}" class="tm-product-delete-link" data-id="{{this._id}}" data-toggle="modal" data-target="#modalDelete">
                                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                                </a>
                            </td>
                        </tr>
                        {{/each}}
                </tbody>
            </table>
        </div>
        <!-- table container -->
        <a
            href="product/create"
            class="btn btn-primary btn-block text-uppercase mb-3">Add new product</a>
        <a href="/product/deleteAllSelected" id="btnDeleteAllSelect" class="btn btn-primary btn-block text-uppercase check-all-submit-btn disabled text-white" data-toggle="modal" data-target="#modalDeleteAll">
            Delete selected products
        </a>
        </div>
    </div>
    {{!-- <div class="col-sm-12 col-md-12 col-lg-4 col-xl-3 tm-block-col">
        <div class="tm-bg-primary-dark tm-block tm-block-product-categories">
        <h2 class="tm-block-title">Product Categories</h2>
        <div class="tm-product-table-container">
            <table class="table tm-table-small tm-product-table">
            <tbody>
                <tr>
                <td class="tm-product-name">Product Category 1</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 2</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 3</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 4</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 5</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 6</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 7</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 8</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 9</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 10</td>
                <td class="text-center">
                    <a href="#" class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
                <tr>
                <td class="tm-product-name">Product Category 11</td>
                <td class="text-center">
                    <a class="tm-product-delete-link">
                    <i class="far fa-trash-alt tm-product-delete-icon"></i>
                    </a>
                </td>
                </tr>
            </tbody>
            </table>
        </div>
        <!-- table container -->
        <button class="btn btn-primary btn-block text-uppercase mb-3">
            Add new category
        </button>
        </div>
    </div> --}}
</div>


{{!-- form delete --}}
<form name="delete-product-form" method="post"></form>

<script> 

    const alertSuccess = document.getElementById('success')
    if(alertSuccess != undefined){
        setTimeout(() => {
            alertSuccess.style.display = 'none'
        }, 1000)
    }

    document.addEventListener('DOMContentLoaded', function(){
        var productId
        var deleteForm = document.forms['delete-product-form']
        var btnDelete = document.getElementById('btnDelete')
        var btnDeleteAllSelect = document.getElementById('btnDeleteAllSelect')
        var btnDeleteAll = document.getElementById('btnDeleteAll')
        var alert = document.getElementsByClassName('alert')[0]

        const toast = document.getElementById('toast');
        const msg = localStorage.getItem('toastMsg');
        
        let checkboxItemChecked = []
        
        $(document).ready(function() {
            var checkboxItem = $('input[name="productIds[]"]')
            checkboxItem.change(function() {
                if(this.checked === true){
                    checkboxItemChecked.push(this.value)
                }else{
                    checkboxItemChecked = checkboxItemChecked.filter(item => item !== this.value)
                }
                let checkedCount = $('input[name="productIds[]"]:checked').length
                if(checkedCount > 0){
                    btnDeleteAllSelect.classList.remove('disabled')
                }else{
                    btnDeleteAllSelect.classList.add('disabled')
                }
            })

        })

        const formDeleteAll = document.getElementById('formDeleteAll')
        formDeleteAll.addEventListener('submit', async function(e){
            e.preventDefault()
            var ListId = await document.getElementsByClassName('ListId')[0]
            
            ListId.value = checkboxItemChecked.join(',')
            
            const data = {
                id: ListId.value
            };


            try{
                const response = await fetch('http://localhost:3000/product/deleteAllSelected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(data),
                    credentials: 'include',
                })

                if(response.ok){
                    const result = await response.json()
                    localStorage.setItem('toastMsg', result.msg)
                    window.location.href = 'http://localhost:8080/product';
                }else{
                    const errorMessage = await response.text();
                    alert.textContent = 'Có lỗi xảy ra';
                    alert.style.display = 'block';
                }
            }catch(error){
                alert.textContent = 'Có lỗi xảy ra';
                alert.style.display = 'block';
            }

        })


        $('#modalDelete').on('show.bs.modal', function(event){
            var button = $(event.relatedTarget)
            productId = button.data('id')
        })

        //btnDelete.onclick = function() {
        //    deleteForm.action = '/product/' + productId + '?_method=DELETE'
        //    deleteForm.submit()
        //}

        //Fetch api deleted
        btnDelete.onclick = async function(){
            try{
                const response = await fetch(`http://localhost:3000/product/${productId}`,{
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    
                })
                
                if(response.ok){
                    const result = await response.json()
                    localStorage.setItem('toastMsg', result.msg)
                    window.location.href = 'http://localhost:8080/product';
                }else{
                    const errorMessage = await response.text();
                    alert.textContent = errorMessage || 'Có lỗi xảy ra';
                    alert.style.display = 'block';
                }    
            }catch(error){
                console.error("Fetch error: ", error);
                alert.textContent = 'Có lỗi xảy ra';
                alert.style.display = 'block';
            }
        }


        //toast message

        if (msg) {
        
            toast.textContent = msg;
            toast.classList.remove('d-none'); 

            setTimeout(() => {
                toast.classList.add('d-none'); 
                localStorage.removeItem('toastMsg');
            }, 2000);
        }

    })

</script>